<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Rust Macros Learning | Emily's Blog</title><meta name=keywords content><meta name=description content="The Rust macro learning: A Methodical Introduction Macros in the AST There are four types of macros in rust.
macro_rules! As noted previously, macro_rules! is itself a syntax extension, meaning it is technically not part of the Rust Syntax. It uses the following forms:
1 2 3 4 5 6 macro_rules! $name { $rule0 ; $rule1 ; // ... $ruleN ; } There must be at least one rule, and you can omit the semicolon after the last rule."><meta name=author content="Emily"><link rel=canonical href=https://emerz3.github.io/posts/rust-macros-learning/><link crossorigin=anonymous href=/assets/css/stylesheet.min.6df975f3ac48679ddac1248ff570b5a6890267d864d3c307f36ff2751343df3d.css integrity="sha256-bfl186xIZ53awSSP9XC1pokCZ9hk08MH82/ydRND3z0=" rel="preload stylesheet" as=style><link rel=icon href=https://emerz3.github.io/favicon.ico><link rel=apple-touch-icon href=https://emerz3.github.io/apple-touch-icon.png><script async defer data-website-id=b6b781e9-cf10-484a-a170-fc9083da6c9f src=https://oishii.reorx.com/oishii.js></script><meta name=twitter:card content="summary"><meta name=twitter:title content="Rust Macros Learning | Emily's Blog"><meta name=twitter:description content="The Rust macro learning: A Methodical Introduction Macros in the AST There are four types of macros in rust.
macro_rules! As noted previously, macro_rules! is itself a syntax extension, meaning it is technically not part of the Rust Syntax. It uses the following forms:
1 2 3 4 5 6 macro_rules! $name { $rule0 ; $rule1 ; // ... $ruleN ; } There must be at least one rule, and you can omit the semicolon after the last rule."><meta property="og:title" content="Rust Macros Learning | Emily's Blog"><meta property="og:description" content="The Rust macro learning: A Methodical Introduction Macros in the AST There are four types of macros in rust.
macro_rules! As noted previously, macro_rules! is itself a syntax extension, meaning it is technically not part of the Rust Syntax. It uses the following forms:
1 2 3 4 5 6 macro_rules! $name { $rule0 ; $rule1 ; // ... $ruleN ; } There must be at least one rule, and you can omit the semicolon after the last rule."><meta property="og:type" content="article"><meta property="og:url" content="https://emerz3.github.io/posts/rust-macros-learning/"><meta property="og:image" content="https://emerz3.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-16T19:23:26+08:00"><meta property="article:modified_time" content="2022-04-16T19:23:26+08:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://emerz3.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Rust Macros Learning","item":"https://emerz3.github.io/posts/rust-macros-learning/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Rust Macros Learning | Emily's Blog","name":"Rust Macros Learning","description":"The Rust macro learning: A Methodical Introduction Macros in the AST There are four types of macros in rust.\nmacro_rules! As noted previously, macro_rules! is itself a syntax extension, meaning it is technically not part of the Rust Syntax. It uses the following forms:\n1 2 3 4 5 6 macro_rules! $name { $rule0 ; $rule1 ; // ... $ruleN ; } There must be at least one rule, and you can omit the semicolon after the last rule.","keywords":[],"wordCount":"988","inLanguage":"en","datePublished":"2022-04-16T19:23:26+08:00","dateModified":"2022-04-16T19:23:26+08:00","author":[{"@type":"Person","name":"Emily"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://emerz3.github.io/posts/rust-macros-learning/"},"publisher":{"@type":"Organization","name":"Emily's Blog","logo":{"@type":"ImageObject","url":"https://emerz3.github.io/favicon.ico"}}}</script><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary-bg:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list-page{background:var(--theme)}.list-page:not(.dark)::-webkit-scrollbar-track{background:0 0}.list-page:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript></head><body class="type-posts kind-page layout-" id=top><script data-no-instant>function switchTheme(e){switch(e){case"light":document.body.classList.remove("dark");break;case"dark":document.body.classList.add("dark");break;default:window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")}}function isDarkTheme(){return document.body.className.includes("dark")}function getPrefTheme(){return localStorage.getItem("pref-theme")}function setPrefTheme(e){switchTheme(e),localStorage.setItem("pref-theme",e)}const toggleThemeCallbacks={};toggleThemeCallbacks.main=e=>{setPrefTheme(e?"light":"dark")},window.addEventListener("toggle-theme",function(){const e=isDarkTheme();for(const t in toggleThemeCallbacks)toggleThemeCallbacks[t](e)});function toggleThemeListener(){window.dispatchEvent(new CustomEvent("toggle-theme"))}</script><script>(function(){const t="auto",e=getPrefTheme(),n=e||t;switchTheme(n)})()</script><header class=header><nav class=nav><div class=logo><a href=https://emerz3.github.io/ accesskey=h title="Emily's Blog (Alt + H)">Emily's Blog</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://emerz3.github.io/posts/ title=posts class=active>posts</a></li><li><a href=https://emerz3.github.io/tags/ title=tags>tags</a></li><li><a href=https://emerz3.github.io/diary/ title=diary>diary</a></li><li><a href=https://emerz3.github.io/about/ title=about>about</a></li></ul></nav></header><main class="main post"><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://emerz3.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://emerz3.github.io/posts/>Posts</a></div><h1 class=post-title>Rust Macros Learning</h1><div class=post-meta><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2022-04-16</span></span><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg>
<span>988 words</span></span><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>5 min</span></span></div></header><div class=post-content><h1 id=the-rust-macro-learning-a-methodical-introduction>The Rust macro learning: A Methodical Introduction<a hidden class=anchor aria-hidden=true href=#the-rust-macro-learning-a-methodical-introduction>¶</a></h1><h2 id=macros-in-the-asthttpsveykrilgithubiotlbormsyntax-extensionsasthtmlmacros-in-the-ast><a href=https://veykril.github.io/tlborm/syntax-extensions/ast.html#macros-in-the-ast>Macros in the AST</a><a hidden class=anchor aria-hidden=true href=#macros-in-the-asthttpsveykrilgithubiotlbormsyntax-extensionsasthtmlmacros-in-the-ast>¶</a></h2><p>There are four types of macros in rust.</p><h2 id=macro_rules>macro_rules!<a hidden class=anchor aria-hidden=true href=#macro_rules>¶</a></h2><p>As noted previously, <code>macro_rules!</code> is <em>itself</em> a syntax extension, meaning it is <em>technically</em> not part of the Rust Syntax. It uses the following forms:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=fm>macro_rules!</span><span class=w> </span><span class=cp>$name</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>$rule0</span><span class=w> </span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>$rule1</span><span class=w> </span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=cp>$ruleN</span><span class=w> </span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>There must be <em>at least</em> one rule, and you can omit the semicolon after the last rule. You can use brackets<code>[]</code>, parentheses<code>()</code> or braces<code>{}</code>.</p><p>Each &ldquo;rule&rdquo; looks like the following:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>    ($matcher) =&gt; {$expansion}
</span></span></code></pre></td></tr></table></div></div><p>Like before, the types of parentheses used can be any kind, but parenthese around the matcher and braces around the expansion are somewhat conventional. The expansion part of a rule is also called its <strong>transcriber</strong>.</p><p>Note that the choice of the parentheses does not matter in regards to how the mbe(macro by example) macro may be invoked. In fact, function-like macros can be invoked with any kind of parentheses as well, but invocations with <code>{ .. }</code> and <code>{ ... };</code>, notice the trailing semicolon, are special in that their expansion will <strong>always</strong> be parsed as an <strong>item</strong>.</p><h2 id=metavariables>Metavariables<a hidden class=anchor aria-hidden=true href=#metavariables>¶</a></h2><p>Matchers can also contain captures. These allow input to be matched based on some general grammer category, with the result captured to a metavariable which can then be substituted into the output.</p><p>Captures are written as a dollar <code>$</code> followed by an identifier, a colon <code>:</code>, and finally the kind of capture which is also called the fragment-specifier, which must be one of the following:</p><ul><li><code>block</code>: a block (i.e. a block of statements and/or an expression, surrounded by braces)</li><li><code>expr</code>: an expression</li><li><code>ident</code>: an identifier (this includes keywords)</li><li><code>item</code>: an item, like a function, struct, module, impl, etc.</li><li><code>lifetime</code>: a lifetime (e.g. <code>'foo</code>, <code>'static</code>, &mldr;)</li><li><code>literal</code>: a literal (e.g. <code>"Hello World!"</code>, <code>3.14</code>, &lsquo;:crab:&rsquo;, &mldr;)</li><li><code>meta</code>: a meta item; teh things that go inside the <code>#[...]</code> and <code>#![...]</code> attributes</li><li><code>pat</code>: a pattern</li><li><code>path</code>: a path (e.g. <code>foo</code>, <code>::std::mem::replace</code>, <code>transmute::&lt;_, int></code>, &mldr;)</li><li><code>stmt</code>: a statment</li><li><code>tt</code>: a single token free</li><li><code>ty</code>: a type</li><li><code>vis</code>: a possible empty visibility qualifier (e.g. <code>pub</code>, <code>pub(in crate)</code>, &mldr;)</li></ul><p>For example, here is a <code>macro_rules!</code> macro which captures its input as an expression under the metavariable <code>$e</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=fm>macro_rules!</span><span class=w> </span><span class=n>one_expression</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=cp>$e</span>:<span class=nc>expr</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=o>..</span><span class=p>.};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>These metavariables leverage the Rust compiler&rsquo;s parser, ensuring that they are always &ldquo;correct&rdquo;. An <code>expr</code> metavariable will <em>always</em> capture a complete, valid expression for the version of Rust being compiled.</p><p>To refer to a metavariable you simply write <code>$name</code>, as the type of the variable is already specified in the matcher. For example:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=fm>macro_rules!</span><span class=w> </span><span class=n>time_five</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=cp>$e</span>:<span class=nc>expr</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=mi>5</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=cp>$e</span><span class=w> </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Much like macro expansion, metavariables are substituted as complete AST nodes. This means that no matter what sequence of tokens is captured by <code>$e</code>, it will be interpreted as a single, complete expression.</p><p>You can also have multiple metavariables in a single matcher:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=fm>macro_rules!</span><span class=w> </span><span class=n>multiply_add</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=cp>$a</span>:<span class=nc>expr</span><span class=p>,</span><span class=w> </span><span class=cp>$b</span>:<span class=nc>expr</span><span class=p>,</span><span class=w> </span><span class=cp>$c</span>:<span class=nc>expr</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=cp>$a</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=p>(</span><span class=cp>$b</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=cp>$c</span><span class=p>)</span><span class=w> </span><span class=p>};</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Add use them as often as you like in the expansion:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=n>marco_rules</span><span class=o>!</span><span class=w> </span><span class=n>discard</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=cp>$e</span>:<span class=nc>expr</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>marco_rules</span><span class=o>!</span><span class=w> </span><span class=n>repeat</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=cp>$e</span>:<span class=nc>expr</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=cp>$e</span><span class=p>;</span><span class=w> </span><span class=cp>$e</span><span class=p>;</span><span class=w> </span><span class=cp>$e</span><span class=p>;</span><span class=w> </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>There is also a special metavariable called <code>$crate</code> which can be used to refer to the current crate.</p><h2 id=repetitions>Repetitions<a hidden class=anchor aria-hidden=true href=#repetitions>¶</a></h2><p>Matchers can contain repetitions. These allow a sequence of tokens to be matched. These have the general form <code>$ ( ... ) sep rep</code>.</p><ul><li><p><code>$</code> is a literal dollar token.</p></li><li><p><code>( ... )</code> is the paren-grouped matcher being repeated.</p></li><li><p><code>sep</code> is an <em>optional</em> separator token. It may not be a delimiter or one of the repetition operators. Common examples are <code>,</code> and <code>;</code>.</p></li><li><p><code>rep</code> is the <em>required</em> repeat operator. Currently, this can be:</p><ul><li><code>?</code>: indicating at most one repetition</li><li><code>*</code>: indicating zero or more repetitions</li><li><code>+</code>: indicating one or more repetitions</li></ul><p>Since <code>?</code> represents at most one occurence, it cannot be used with a separator.</p></li></ul><p>Repetitions can contain any other valid matcher, including literal token trees, metavariables, and other repetitions allowing arbitrary nesting.</p><p>Repetitions use the same syntax in the expansion and repeated metavariables can only be accessed inside of repetitions in the expansion.</p><p>For example, below is a mbe macro which formats each element as a string. It matches zero or more comma-separated expressions and expands to an expression that constructs a vector.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=fm>macro_rules!</span><span class=w> </span><span class=n>vec_strs</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Start a repetition:
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=cp>$(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Each repeat must contain an expression...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=cp>$element</span>:<span class=nc>expr</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...separated by commas...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ...zero or more times.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Enclose the expansion in a block so that we can use 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=c1>// multiple statements.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Vec</span>::<span class=n>new</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Start a repetition
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=cp>$(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Each repeat will contain the following statement, with
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                </span><span class=c1>// $element replaced with the corresponding expression
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                </span><span class=n>v</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=fm>format!</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=cp>$element</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>)</span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>v</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vec_strs</span><span class=o>!</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=s>&#34;a&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=mf>3.14159</span><span class=k>f32</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>assert_eq!</span><span class=p>(</span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=p>[</span><span class=s>&#34;1&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;a&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;true&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;3.14159&#34;</span><span class=p>]);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>You can repeat multiple metavariables in a single repetition as long as all metavariables repeat equally often. So this invocation of the following macro works:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=fm>macro_rules!</span><span class=w> </span><span class=n>repeat_two</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=cp>$($i</span>:<span class=nc>ident</span><span class=p>)</span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=cp>$($i2</span>:<span class=nc>ident</span><span class=p>)</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=cp>$(</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=cp>$i</span>: <span class=p>();</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=cp>$i2</span>: <span class=p>();</span><span class=w> </span><span class=p>)</span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>repeat_two</span><span class=o>!</span><span class=p>(</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=n>f</span><span class=p>,</span><span class=w> </span><span class=n>u</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=n>z</span><span class=w> </span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>But this does not:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=o>..</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>repeat_two</span><span class=o>!</span><span class=p>(</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=n>f</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=p>,</span><span class=w> </span><span class=n>z</span><span class=w> </span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>failing with the error</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=n>error</span><span class=p>:</span><span class=w> </span><span class=n>meta</span><span class=o>-</span><span class=n>variable</span><span class=w> </span><span class=o>`</span><span class=n>i</span><span class=o>`</span><span class=w> </span><span class=n>repeats</span><span class=w> </span><span class=mi>6</span><span class=w> </span><span class=n>times</span><span class=p>,</span><span class=w> </span><span class=n>but</span><span class=w> </span><span class=o>`</span><span class=n>i2</span><span class=o>`</span><span class=w> </span><span class=n>repeats</span><span class=w> </span><span class=mi>3</span><span class=w> </span><span class=n>times</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>--&gt;</span><span class=w> </span><span class=n>src</span><span class=o>/</span><span class=n>main</span><span class=p>.</span><span class=n>rs</span><span class=p>:</span><span class=mi>6</span><span class=p>:</span><span class=mi>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>6</span><span class=w> </span><span class=o>|</span><span class=w>         </span><span class=err>$</span><span class=p>(</span><span class=w> </span><span class=n>let</span><span class=w> </span><span class=err>$</span><span class=n>i</span><span class=p>:</span><span class=w> </span><span class=p>();</span><span class=w> </span><span class=n>let</span><span class=w> </span><span class=err>$</span><span class=n>i2</span><span class=p>:</span><span class=w> </span><span class=p>();</span><span class=w> </span><span class=p>)</span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>          </span><span class=o>^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><footer class=post-footer><nav class=paginav><a class=prev href=https://emerz3.github.io/posts/mark/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></svg>&nbsp;Prev Page</span><br><span>Mark</span></a>
<a class=next href=https://emerz3.github.io/posts/hexo-blog/><span class=title>Next Page&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span><br><span>HEXO Blog</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://emerz3.github.io/>Emily's Blog</a></span><span style=display:inline-block;margin-left:1em>
<a href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA</a></span>
<span style=display:inline-block;margin-left:1em>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
    <a href=https://github.com/reorx/hugo-PaperModX/ rel=noopener target=_blank>PaperModX</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>(function(){const t=""=="1";if(t)return;let e=document.getElementById("theme-toggle");e.removeEventListener("click",toggleThemeListener),e.addEventListener("click",toggleThemeListener)})()</script><script>(function(){let e=document.getElementById("menu");e&&(e.scrollLeft=localStorage.getItem("menu-scroll-position"),e.onscroll=function(){localStorage.setItem("menu-scroll-position",e.scrollLeft)});const t=""=="1",n=""=="1";if(window.matchMedia("(prefers-reduced-motion: reduce)").matches||t||n)return;document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})})()</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>if(window.scrollListeners)for(const e of scrollListeners)window.removeEventListener("scroll",e);window.scrollListeners=[]</script><script src=/js/medium-zoom.min.js data-no-instant></script>
<script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script>(function(){const a=""=="1";if(!a)return;if(!document.querySelector(".toc")){console.log("no toc found, ignore toc scroll");return}const r=window.scrollListeners,t=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id]"),n="active";let e=t[0];o(e).classList.add(n);const c=()=>{const s=[];for(const e of t)if(l(e)<5)s.push(e);else break;s.length>0?newActiveHeading=s[s.length-1]:newActiveHeading=t[0],e!=newActiveHeading&&(o(e).classList.remove(n),e=newActiveHeading,o(e).classList.add(n))};let s=null;const i=()=>{s!==null&&clearTimeout(s),s=setTimeout(c,50)};window.addEventListener("scroll",i,!1),r.push(i);function o(e){const t=encodeURI(e.getAttribute("id")).toLowerCase();return document.querySelector(`.toc ul li a[href="#${t}"]`)}function l(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect();return t.top}})()</script><script>mediumZoom(".entry-cover img"),mediumZoom(".post-content img:not([no-zoom])")</script></body></html>